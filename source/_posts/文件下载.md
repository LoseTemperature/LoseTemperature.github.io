---
title: 文件下载
date: 2025-10-01
tags: [浏览器, 程序员, 技术]
categories: [技术分享]
---

## 1.服务端发起
它的主要作用是告诉浏览器下载一个已经存在于服务器物理磁盘上的文件。

当你在后端代码中调用 res.download() 时，Express 会自动设置一系列关键的 HTTP 响应头 (HTTP Response Headers)。最重要的一个是 Content-Disposition，并将其值设置为 attachment。

Content-Disposition: attachment; filename="your-file-name.ext" 这个头信息是给浏览器的明确指令：“不要试图在页面里渲染或打开这个响应内容，而是应该弹出一个‘另存为...’的对话框，让用户把它保存到本地”。

Express 还会自动设置 Content-Type 头，以便浏览器知道文件的类型（例如 image/jpeg, application/pdf
```js
// server.js
const express = require('express');
const path = require('path');
const app = express();

app.get('/download-invoice', (req, res) => {
  // 假设服务器的 /files 目录下有一个 invoice-2025-09.pdf 文件
  const filePath = path.join(__dirname, 'files', 'invoice-2025-09.pdf');

  // 你可以指定一个不同的文件名提供给用户下载
  const downloadFileName = 'September_Invoice.pdf';

  // 调用 res.download()
  // Express 会处理所有必要的 HTTP 头
  res.download(filePath, downloadFileName, (err) => {
    if (err) {
      // 如果文件不存在或发生错误，可以在这里处理
      console.log(err);
    }
  });
});

app.listen(3000);
```
## 2.客户端发起 
步骤一: 将你想要下载的数据（字符串、JSON、ArrayBuffer等）转换成一个 Blob 对象。

步骤二: 使用 URL.createObjectURL(blob) 为这个 Blob 对象在浏览器内部创建一个临时的、唯一的 URL。这个 URL 指向的是浏览器内存中的数据，而不是一个网络地址。

步骤三: 创建一个隐藏的 <a> 标签。

步骤四: 将 <a> 标签的 href 属性设置为刚刚创建的 Object URL。

步骤五: 设置 <a> 标签的 download 属性为你希望的文件名。这个属性是关键，它告诉浏览器点击链接时是下载而不是导航。

步骤六: 用 JavaScript 模拟用户点击这个 <a> 标签 (link.click())，从而触发下载。

步骤七: （可选但推荐）下载触发后，使用 URL.revokeObjectURL() 释放之前创建的 Object URL 以节省内存。
```js
function downloadTextAsFile(filename, text) {
  // 步骤一: 创建 Blob 对象
  const blob = new Blob([text], { type: 'text/plain' });

  // 步骤二: 创建 Object URL
  const url = URL.createObjectURL(blob);

  // 步骤三: 创建 <a> 标签
  const link = document.createElement('a');

  // 步骤四 & 五: 设置 href 和 download 属性
  link.href = url;
  link.download = filename;

  // 附加到 DOM 以确保可点击
  document.body.appendChild(link);

  // 步骤六: 模拟点击
  link.click();

  // 步骤七: 清理
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// 如何使用它：
// downloadTextAsFile('my-notes.txt', '这是我想保存的笔记内容。');
```
