---
title: æ·±å…‹éš†æ‰‹å†™
date: 2025-01-11
tags: [æµè§ˆå™¨, ç¨‹åºå‘˜, æŠ€æœ¯]
categories: [æŠ€æœ¯åˆ†äº«]
---

# ğŸ§  æ‰‹å†™æ·±æ‹·è´ï¼ˆDeep Cloneï¼‰å…¨è¿‡ç¨‹ç¬”è®°

> è¿™æ˜¯ä¸€ä»½å®Œæ•´çš„æ·±æ‹·è´å®ç°ç¬”è®°ï¼Œè®°å½•äº†æˆ‘ä»æœ€åŸºç¡€ç‰ˆæœ¬åˆ°å¤„ç†å¾ªç¯å¼•ç”¨ã€ç‰¹æ®Šç±»å‹ã€Symbol å±æ€§ã€å¼±å¼•ç”¨ä¼˜åŒ–çš„æ•´ä¸ªæ€è€ƒä¸æ¨å¯¼è¿‡ç¨‹ã€‚  
> æ³¨é‡Šæ˜¯çµé­‚ï¼Œç»†èŠ‚æ˜¯é‡ç‚¹ã€‚

---

## ğŸ§© 1ï¸âƒ£ åŸºç¡€ç‰ˆï¼šæ„å»ºæ·±æ‹·è´æ¡†æ¶

```js
// æ‰‹å†™æ·±æ‹·è´
// 1. æ„å»ºåŸºç¡€çš„æ‹·è´æ¡†æ¶
function deepClone0(obj) {
  // æ·±æ‹·è´ä¸»è¦æ˜¯é’ˆå¯¹æ•°ç»„ä¸å¯¹è±¡ï¼ŒåŸºç¡€ç±»å‹è¿”å›è‡ªèº«å³å¯
  if (obj === null || typeof obj !== 'object') {
    return obj
  }

  // ä¸»è¦æ˜¯åŒºåˆ†æ•°ç»„ä¸å¯¹è±¡çš„è®¿é—®æ–¹å¼
  // æ•°ç»„æ˜¯ç”¨ç´¢å¼•è®¿é—®ï¼Œè€Œå¯¹è±¡æ˜¯é”®å€¼å¯¹
  let newObj = Array.isArray(obj) ? [] : {}

  for (let key in obj) {
    // hasOwnProperty ä¼šä¿è¯æˆ‘ä»¬ä¸è®¿é—®åˆ°åŸå‹é“¾ä¸Šçš„å±æ€§ï¼Œåªè®¿é—®å¯¹è±¡è‡ªèº«çš„å±æ€§
    if (obj.hasOwnProperty(key)) {
      newObj[key] = deepClone0(obj[key])
    }
  }
  return newObj
}
ğŸ§  æ€»ç»“ï¼š
è¿™æ˜¯æœ€åŸºç¡€çš„é€’å½’æ‹·è´å®ç°ã€‚
ä½†æ˜¯â€”â€”å®ƒæ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹é—®é¢˜ã€‚

âš ï¸ 2ï¸âƒ£ å¾ªç¯å¼•ç”¨é—®é¢˜
js
å¤åˆ¶ä»£ç 
// ä¸¾ä¸ªä¾‹å­ï¼š
let obj = {}
obj.a = obj
deepClone0(obj) // âŒ æ— é™é€’å½’ï¼Œæ ˆæº¢å‡º
åŸå› ï¼š
a å¼•ç”¨äº† obj è‡ªèº«ï¼Œåœ¨é€’å½’è¿‡ç¨‹ä¸­æ°¸è¿œä¸ä¼šåœæ­¢ã€‚

âœ… æ”¹è¿›ï¼šä½¿ç”¨ Map è§£å†³å¾ªç¯å¼•ç”¨
js
å¤åˆ¶ä»£ç 
function deepClone1(obj, map = new Map()) {
  if (obj === null || typeof obj !== 'object') {
    return obj;
  }

  // ç”¨ map è®°å½•å·²ç»æ‹·è´è¿‡çš„å¯¹è±¡
  // å¦‚æœ map ä¸­æœ‰ï¼Œè¯´æ˜å·²ç»æ‹·è´è¿‡ï¼Œç›´æ¥è¿”å›ç¼“å­˜çš„å‰¯æœ¬
  if (map.has(obj)) {
    return map.get(obj);
  }

  let newObj = Array.isArray(obj) ? [] : {};
  map.set(obj, newObj); // ç™»è®°æ‹·è´ä¿¡æ¯ï¼Œé˜²æ­¢é‡å¤é€’å½’

  for (let key in obj) {
    if (obj.hasOwnProperty(key)) {
      // æ³¨æ„è¿™é‡Œé€’å½’æ—¶è¦ç»§ç»­ä¼ å…¥ map
      newObj[key] = deepClone1(obj[key], map);
    }
  }
  return newObj;
}
ğŸ§  çŸ¥è¯†ç‚¹è¡¥å……ï¼š

Map æ˜¯ä¸€ç§å“ˆå¸Œè¡¨ï¼Œç”¨æ¥ç¼“å­˜å·²æ‹·è´çš„å¯¹è±¡ã€‚

è¿™ç§æ€è·¯ä¹Ÿæ˜¯å¸¸è§çš„â€œç¼“å­˜æœºåˆ¶ / å“ˆå¸Œç¼“å­˜ï¼ˆcacheï¼‰â€çš„åº•å±‚åŸç†ã€‚

ğŸ§± 3ï¸âƒ£ å¤„ç†ç‰¹æ®Šå¯¹è±¡ç±»å‹ï¼šDateã€RegExp
æˆ‘ä»¬å‘ç°å³ä½¿è§£å†³äº†å¾ªç¯å¼•ç”¨ï¼ŒDateã€RegExp ä¾ç„¶è¢«æ‹·è´æˆ {}ã€‚
åŸå› å¦‚ä¸‹ï¼š

åœ¨ JavaScript ä¸­ï¼Œå¤§å¤šæ•°å¯¹è±¡çš„åŸå‹éƒ½æ˜¯ Object.prototypeã€‚
ä½†åƒ Dateã€RegExp è¿™æ ·çš„ç‰¹æ®Šå¯¹è±¡ï¼Œå®ƒä»¬çš„åŸå‹æ˜¯è‡ªå·±æ„é€ å‡½æ•°çš„åŸå‹ã€‚
è€Œæˆ‘ä»¬çš„å®ç°ä¸­ç”¨ {} æˆ– [] åˆ›å»ºå‰¯æœ¬ï¼Œå¯¼è‡´åŸå‹é”™è¯¯ã€‚

âœ… æ”¹è¿›ç‰ˆæœ¬ï¼šé€šè¿‡ obj.constructor ä¿ç•™åŸæ„é€ å‡½æ•°
js
å¤åˆ¶ä»£ç 
function deepClone2(obj, map = new Map()) {
  if (obj === null || typeof obj !== 'object') {
    return obj;
  }

  // ç‰¹æ®Šç±»å‹å•ç‹¬å¤„ç†
  if (obj instanceof Date) return new Date(obj);
  if (obj instanceof RegExp) return new RegExp(obj);

  // å¤„ç†å¾ªç¯å¼•ç”¨
  if (map.has(obj)) {
    return map.get(obj);
  }

  // å…³é”®ç‚¹ï¼šç”¨åŸå¯¹è±¡çš„æ„é€ å‡½æ•°åˆ›å»ºæ–°å¯¹è±¡
  // è¿™æ ·å°±ä¿è¯äº†åŸå‹é“¾æ˜¯ç»§æ‰¿è‡ªåŸå¯¹è±¡çš„ï¼Œè€Œä¸æ˜¯ Object.prototype
  const newObj = new obj.constructor();
  map.set(obj, newObj);

  for (let key in obj) {
    if (obj.hasOwnProperty(key)) {
      newObj[key] = deepClone2(obj[key], map);
    }
  }
  return newObj;
}
ğŸ” åŸå‹é“¾è¡¥å……è¯´æ˜ï¼š
åœ¨ JS ä¸­ï¼š

javascript
å¤åˆ¶ä»£ç 
person -> person.__proto__ -> Person.prototype -> Object.prototype -> null
obj.constructor å®é™…ä¸Šæ˜¯æŒ‡å‘ obj.__proto__.constructorï¼Œ
å› æ­¤ new obj.constructor() ä¼šç”Ÿæˆä¸åŸå¯¹è±¡ç›¸åŒåŸå‹é“¾çš„å®ä¾‹ã€‚

ğŸ”® 4ï¸âƒ£ å¤„ç† Symbol ä¸ä¸å¯æšä¸¾å±æ€§
for...in ä¸èƒ½éå† Symbol é”®ï¼Œä¹Ÿæ— æ³•è®¿é—®ä¸å¯æšä¸¾å±æ€§ã€‚
æˆ‘ä»¬ä½¿ç”¨ Reflect.ownKeys(obj) æ¥å–ä»£ for...inã€‚

Reflect.ownKeys(obj) çš„ä¼˜ç‚¹ï¼š

ä¸ä¼šéå†åŸå‹é“¾ï¼›

èƒ½åŒæ—¶è·å–å­—ç¬¦ä¸²é”®ä¸ Symbol é”®ï¼›

èƒ½å–åˆ°ä¸å¯æšä¸¾å±æ€§ã€‚

âœ… æ”¹è¿›ç‰ˆæœ¬ï¼šæ”¯æŒ Symbol
js
å¤åˆ¶ä»£ç 
function deepClone3(obj, map = new Map()) {
  if (obj === null || typeof obj !== 'object') {
    return obj;
  }

  if (obj instanceof Date) return new Date(obj);
  if (obj instanceof RegExp) return new RegExp(obj);

  if (map.has(obj)) {
    return map.get(obj);
  }

  const newObj = new obj.constructor();
  map.set(obj, newObj);

  // Reflect.ownKeys(obj) æ›¿æ¢æ‰ for...in
  Reflect.ownKeys(obj).forEach(key => {
    // key å¯èƒ½æ˜¯ 'name'ï¼Œä¹Ÿå¯èƒ½æ˜¯ Symbol('id')
    newObj[key] = deepClone3(obj[key], map);
  });

  return newObj;
}
ğŸ§¹ 5ï¸âƒ£ WeakMap è§£å†³å¼ºå¼•ç”¨å†…å­˜æ³„æ¼é—®é¢˜
ğŸ§© é—®é¢˜ï¼š
åœ¨é€’å½’ä¸­ï¼Œmap ä¼šä¿å­˜åŸå¯¹è±¡çš„å¼ºå¼•ç”¨ã€‚
å³ä½¿å¯¹è±¡è¢«å…¶ä»–å¼•ç”¨é‡Šæ”¾ï¼Œåªè¦ map è¿˜å­˜åœ¨ï¼ŒGC ä¹Ÿä¸ä¼šå›æ”¶é‚£å—å†…å­˜ã€‚

âœ… è§£å†³æ–¹æ¡ˆï¼š
ä½¿ç”¨ WeakMap æ›¿ä»£ Mapï¼Œå› ä¸ºå®ƒçš„é”®æ˜¯å¼±å¼•ç”¨ï¼Œä¸ä¼šé˜»æ­¢ GC å›æ”¶åŸå¯¹è±¡å†…å­˜ã€‚

ğŸ”§ æœ€ç»ˆç‰ˆï¼šå®Œå–„åçš„æ·±æ‹·è´å‡½æ•°
js
å¤åˆ¶ä»£ç 
function deepClone3(obj, map = new WeakMap()) { // æ”¹ä¸º WeakMap
  if (obj === null || typeof obj !== 'object') {
    return obj;
  }

  if (obj instanceof Date) return new Date(obj);
  if (obj instanceof RegExp) return new RegExp(obj);

  if (map.has(obj)) {
    return map.get(obj);
  }

  const newObj = new obj.constructor();
  map.set(obj, newObj);

  // ä½¿ç”¨ Reflect.ownKeys å¤åˆ¶æ‰€æœ‰é”®ï¼ˆå« Symbolã€ä¸å¯æšä¸¾ï¼‰
  Reflect.ownKeys(obj).forEach(key => {
    newObj[key] = deepClone3(obj[key], map);
  });

  return newObj;
}
âœ… å°ç»“ä¸å¯¹æ¯”
ç‰ˆæœ¬	ç‰¹æ€§	é—®é¢˜
deepClone0	åŸºç¡€é€’å½’å®ç°	å¾ªç¯å¼•ç”¨å¯¼è‡´æ ˆæº¢å‡º
deepClone1	åŠ å…¥ Map ç¼“å­˜	ç‰¹æ®Šç±»å‹å¤±çœŸ
deepClone2	å¤„ç† Date/RegExp	æ— æ³•å¤åˆ¶ Symbol
deepClone3	æ”¯æŒ Symbol ä¸ä¸å¯æšä¸¾å±æ€§	ä»å­˜åœ¨å¼ºå¼•ç”¨
deepClone3(WeakMap)	å¼±å¼•ç”¨å®‰å…¨ç‰ˆ	âœ… æœ€ç»ˆå®Œå–„å®ç°

ğŸ§  ç›¸å…³çŸ¥è¯†ç‚¹å›é¡¾
åƒåœ¾å›æ”¶æœºåˆ¶ï¼ˆGCï¼‰

å¼•ç”¨è®¡æ•° / æ ‡è®°æ¸…é™¤ / æ ‡è®°æ•´ç†

WeakMap å¼±å¼•ç”¨ä¸ä¼šé˜»æ­¢ GCã€‚

åŸå‹é“¾ç†è§£

æ„é€ å‡½æ•°ä¸ __proto__ã€prototype çš„å…³ç³»ã€‚

å¯¹è±¡éå†æ–¹å¼å¯¹æ¯”

æ–¹æ³•	æ˜¯å¦éå†åŸå‹é“¾	æ˜¯å¦å– Symbol	æ˜¯å¦å–ä¸å¯æšä¸¾å±æ€§
for...in	âœ… æ˜¯	âŒ å¦	âŒ å¦
Object.keys()	âŒ å¦	âŒ å¦	âŒ å¦
Reflect.ownKeys()	âŒ å¦	âœ… æ˜¯	âœ… æ˜¯

ğŸ§ª æµ‹è¯•ç”¨ä¾‹
js
å¤åˆ¶ä»£ç 
const obj = {
  name: 'Tom',
  age: 18,
  date: new Date(),
  reg: /abc/g,
  arr: [1, 2, 3],
  [Symbol('id')]: 100,
}

obj.self = obj // å¾ªç¯å¼•ç”¨

const clone = deepClone3(obj)

console.log(clone)
console.log(clone === obj) // false
console.log(clone.arr === obj.arr) // false
console.log(clone.date instanceof Date) // true
console.log(Object.getOwnPropertySymbols(clone)) // âœ… èƒ½å–åˆ° Symbol
ğŸ ç»“è¯­
æ·±æ‹·è´è¿™é“é¢˜ï¼Œçœ‹ä¼¼ç®€å•ï¼Œå®åˆ™æ˜¯å¯¹ä»¥ä¸‹çŸ¥è¯†ç‚¹çš„ç»¼åˆè€ƒå¯Ÿï¼š

JS ç±»å‹ç³»ç»Ÿï¼ˆåŸºç¡€ç±»å‹ vs å¼•ç”¨ç±»å‹ï¼‰

åŸå‹é“¾ç»§æ‰¿æœºåˆ¶

Map / WeakMap çš„å¼•ç”¨è¯­ä¹‰

Reflect / Symbol ç­‰ ES6 ç‰¹æ€§

åƒåœ¾å›æ”¶ï¼ˆGCï¼‰ç†è§£

ğŸ’¬ èƒ½ä» deepClone0 å†™åˆ° deepClone3(WeakMap)ï¼Œ
å°±ç®—æ˜¯å½»åº•é€šé€äº† JS å¯¹è±¡ç»“æ„çš„åº•å±‚é€»è¾‘ã€‚








